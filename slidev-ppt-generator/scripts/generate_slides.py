#!/usr/bin/env python3
"""
Slidev PPT ç”Ÿæˆè„šæœ¬
å°†é•¿æ–‡æœ¬è‡ªåŠ¨è½¬æ¢ä¸º Slidev Markdown æ ¼å¼

ç”¨æ³•:
    python generate_slides.py "ä½ çš„æ–‡ç« å†…å®¹"
    python generate_slides.py --file article.txt
    python generate_slides.py --file article.txt --output slides.md
"""

import sys
import os
import re
import argparse


def extract_title(content):
    """ä»å†…å®¹ä¸­æå–æ ‡é¢˜ï¼ˆé€šå¸¸æ˜¯ç¬¬ä¸€è¡Œæˆ–ç¬¬ä¸€æ®µï¼‰"""
    lines = content.strip().split('\n')
    
    # å°è¯•æ‰¾ç¬¬ä¸€è¡Œéç©ºè¡Œ
    for line in lines:
        line = line.strip()
        if line and len(line) < 100:
            return line
    
    return "æ¼”ç¤ºæ–‡ç¨¿"


def split_into_sections(content):
    """å°†å†…å®¹æ‹†åˆ†ä¸ºå¤šä¸ªç« èŠ‚"""
    # æŒ‰å¸¸è§åˆ†éš”ç¬¦æ‹†åˆ†
    # æ”¯æŒï¼š## æ ‡é¢˜ã€æ•°å­—+ç‚¹+æ ‡é¢˜ã€æ¢è¡Œæ¢è¡Œ
    
    sections = []
    
    # é¦–å…ˆå°è¯•æŒ‰ markdown æ ‡é¢˜æ‹†åˆ†
    pattern = r'(?:^|\n)(#{1,3}\s+.+?)(?=\n#{1,3}\s|\Z)'
    matches = list(re.finditer(pattern, content, re.DOTALL))
    
    if len(matches) >= 2:
        # ä½¿ç”¨ markdown æ ‡é¢˜ä½œä¸ºåˆ†å‰²
        for match in matches:
            section = match.group(1).strip()
            if section:
                sections.append(section)
    else:
        # æŒ‰æ®µè½æ‹†åˆ†
        paragraphs = [p.strip() for p in content.split('\n\n') if p.strip()]
        
        # åˆå¹¶çŸ­æ®µè½ï¼Œå½¢æˆåˆç†é•¿åº¦çš„é¡µé¢
        current_section = []
        for p in paragraphs:
            current_section.append(p)
            # å¦‚æœæ®µè½å¤Ÿé•¿æˆ–åŒ…å«å¥å·ï¼ˆå®Œæ•´å¥å­ï¼‰ï¼Œç»“æŸå½“å‰section
            if len(p) > 100 or p.endswith('ã€‚') or p.endswith('.'):
                sections.append('\n\n'.join(current_section))
                current_section = []
        
        if current_section:
            sections.append('\n\n'.join(current_section))
    
    return sections


def format_bullets(text):
    """å°†æ–‡æœ¬è½¬æ¢ä¸º bullet points"""
    lines = text.split('\n')
    bullets = []
    
    for line in lines:
        line = line.strip()
        if not line:
            continue
        
        # ç§»é™¤ markdown æ ‡è®°
        line = re.sub(r'^#{1,3}\s*', '', line)  # ç§»é™¤æ ‡é¢˜æ ‡è®°
        line = re.sub(r'^[-*+]?\s*', '', line)  # ç§»é™¤å·²æœ‰åˆ—è¡¨æ ‡è®°
        
        if line and len(line) > 5:  # è¿‡æ»¤å¤ªçŸ­çš„è¡Œ
            bullets.append(line)
    
    return bullets


def generate_slidev_markdown(title, sections, theme="seriph"):
    """ç”Ÿæˆ Slidev Markdown å†…å®¹"""
    
    lines = []
    
    # Frontmatter
    lines.extend([
        "---",
        f'theme: {theme}',
        "background: https://source.unsplash.com/collection/9473456/1920x1080",
        "class: text-center",
        "highlighter: shiki",
        "lineNumbers: true",
        "info: |",
        f"  ## {title}",
        "  Generated by Slidev PPT Generator",
        "drawings:",
        "  persist: false",
        "transition: slide-left",
        f"title: {title}",
        "---\n"
    ])
    
    # æ ‡é¢˜é¡µ
    lines.extend([
        f"# {title}",
        "",
        "Generated with â¤ï¸ by AI Assistant",
        "",
        "<!-- æ¼”è®²è€…å¤‡æ³¨ï¼šè¿™æ˜¯å¼€åœºç™½ -->\n"
    ])
    
    # ç›®å½•é¡µï¼ˆå¦‚æœç« èŠ‚è¶³å¤Ÿå¤šï¼‰
    if len(sections) > 3:
        lines.extend([
            "---",
            "layout: center",
            "class: text-center",
            "---\n",
            "# ç›®å½•",
            "",
        ])
        for i, section in enumerate(sections[:6], 1):  # æœ€å¤šæ˜¾ç¤º6ä¸ª
            # æå–ç« èŠ‚æ ‡é¢˜ï¼ˆç¬¬ä¸€è¡Œæˆ–å‰30ä¸ªå­—ç¬¦ï¼‰
            section_title = section.split('\n')[0][:30]
            lines.append(f"{i}. {section_title}")
        lines.append("\n")
    
    # å†…å®¹é¡µ
    for i, section in enumerate(sections, 1):
        lines.append("---")
        lines.append("layout: default")
        lines.append("---\n")
        
        # æå–ç« èŠ‚æ ‡é¢˜
        section_lines = section.split('\n')
        raw_title = section_lines[0].strip()
        
        # æ¸…ç†æ ‡é¢˜ä¸­çš„ markdown æ ‡è®°
        clean_title = re.sub(r'^#{1,3}\s*', '', raw_title)
        if not clean_title or len(clean_title) < 3:
            clean_title = f"ç¬¬ {i} éƒ¨åˆ†"
        
        lines.append(f"# {clean_title}")
        lines.append("")
        
        # å‰©ä½™å†…å®¹è½¬ä¸º bullet points
        remaining_text = '\n'.join(section_lines[1:])
        bullets = format_bullets(remaining_text)
        
        if bullets:
            for bullet in bullets[:6]:  # æ¯é¡µæœ€å¤š6ä¸ª bullet
                lines.append(f"- {bullet}")
        else:
            # å¦‚æœæ²¡æœ‰æå–åˆ° bulletsï¼Œæ˜¾ç¤ºæ‘˜è¦
            summary = remaining_text[:200] + "..." if len(remaining_text) > 200 else remaining_text
            lines.append(summary)
        
        lines.append("")
        lines.append(f"<!-- æ¼”è®²è€…å¤‡æ³¨ï¼š{clean_title} çš„è¡¥å……è¯´æ˜ -->\n")
    
    # ç»“æŸé¡µ
    lines.extend([
        "---",
        "layout: center",
        "class: text-center",
        "---\n",
        "# æ„Ÿè°¢è§‚çœ‹",
        "",
        "æ¬¢è¿æé—®ä¸äº¤æµ ğŸ‘‹",
        "",
        "<!-- æ¼”è®²è€…å¤‡æ³¨ï¼šç»“æŸè¯­ï¼Œé‚€è¯·äº’åŠ¨ -->\n"
    ])
    
    return "\n".join(lines)


def main():
    parser = argparse.ArgumentParser(description='å°†æ–‡æœ¬è½¬æ¢ä¸º Slidev Markdown')
    parser.add_argument('content', nargs='?', help='æ–‡ç« å†…å®¹ï¼ˆç›´æ¥è¾“å…¥ï¼‰')
    parser.add_argument('--file', '-f', help='ä»æ–‡ä»¶è¯»å–æ–‡ç« å†…å®¹')
    parser.add_argument('--output', '-o', default='slides.md', help='è¾“å‡ºæ–‡ä»¶è·¯å¾„ï¼ˆé»˜è®¤ï¼šslides.mdï¼‰')
    parser.add_argument('--theme', '-t', default='seriph', help='Slidev ä¸»é¢˜ï¼ˆé»˜è®¤ï¼šseriphï¼‰')
    
    args = parser.parse_args()
    
    # è·å–å†…å®¹
    if args.file:
        if not os.path.exists(args.file):
            print(f"âŒ é”™è¯¯ï¼šæ–‡ä»¶ä¸å­˜åœ¨ - {args.file}")
            sys.exit(1)
        with open(args.file, 'r', encoding='utf-8') as f:
            content = f.read()
    elif args.content:
        content = args.content
    else:
        # å°è¯•ä»æ ‡å‡†è¾“å…¥è¯»å–
        content = sys.stdin.read()
        if not content.strip():
            print("âŒ é”™è¯¯ï¼šæœªæä¾›æ–‡ç« å†…å®¹")
            print("ç”¨æ³•ï¼š")
            print("  python generate_slides.py 'ä½ çš„æ–‡ç« å†…å®¹'")
            print("  python generate_slides.py --file article.txt")
            print("  echo 'æ–‡ç« å†…å®¹' | python generate_slides.py")
            sys.exit(1)
    
    # æå–æ ‡é¢˜
    title = extract_title(content)
    
    # æ‹†åˆ†ä¸ºç« èŠ‚
    sections = split_into_sections(content)
    
    print(f"ğŸ“„ æ ‡é¢˜ï¼š{title}")
    print(f"ğŸ“‘ ç« èŠ‚æ•°ï¼š{len(sections)}")
    print(f"ğŸ¨ ä¸»é¢˜ï¼š{args.theme}")
    
    # ç”Ÿæˆ Slidev Markdown
    markdown = generate_slidev_markdown(title, sections, args.theme)
    
    # å†™å…¥æ–‡ä»¶
    with open(args.output, 'w', encoding='utf-8') as f:
        f.write(markdown)
    
    print(f"âœ… å·²ç”Ÿæˆï¼š{args.output}")
    print(f"ğŸš€ è¿è¡Œ 'npm run dev' é¢„è§ˆæ¼”ç¤ºæ–‡ç¨¿")


if __name__ == '__main__':
    main()
